version: '3.3'
services:
  db:
    image: postgres
    hostname: "yuniql-platformtest-db"
    environment:
      POSTGRES_USER: "app"
      POSTGRES_PASSWORD: "app"
      POSTGRES_DB: "yuniqldb"

    ports:
      - "5432:5432"
    # healthcheck:
    #   test: [ "CMD", "/opt/mssql-tools/bin/sqlcmd","-s", "platformtest-db.yuniql.org", "-U", "sa", "-P", "P@ssw0rd!", "-Q", "SELECT 1" ]
    #   interval: 1s
    #   retries: 20
    tty: true
    networks:
      testvnet:
        aliases:
          - platformtest-db.yuniql.org

  app:
    image: rdagumampan/yuniql-platformtest:postgresql
    hostname: "yuniql-platformtest-app"
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      YUNIQL_CONNECTION_STRING: "Host=localhost;Port=5432;Username=app;Password=app;Database=yuniqldb"
      YUNIQL_TEST_CONNECTION_STRING: "Host=localhost;Port=5432;Username=app;Password=app;Database=yuniqldb"
      YUNIQL_TEST_TARGET_PLATFORM: "postgresql"
    entrypoint: /bin/bash -c "/bin/bash -c \"dotnet test\""
    tty: true
    depends_on:
      - db
#      db:
#        condition: service_healthy
    networks:
      testvnet:
        aliases:
          - platformtest-app.yuniql.org

networks:
  testvnet:
    driver: bridge